---
layout: page
section: analystRU
title: "Настройки проекта"
date: 2017-08-25 15:00:00
order: 1
---

В зависимости от особенностей архитектуры вашего сайта могут отличаться и настройки проекта. Если ваш сайт построен на технологии AJAX, или разные разделы сайта располагаются на разных поддоменах и в некоторых других случаях вам необходимо сделать ряд настроек.

### Навигация по странице
------
<ul class="page-navigation">
  <li><a href="#intro">Введение</a></li>
  <li><a href="#sendViewedPageEvent">Автоматическая отправка события Viewed Page</a></li>
  <li><a href="#useCookieStorage">Использовать Cookie вместо LocalStorage для хранения данных</a></li>
  <li><a href="#sessionLength">Длина сессии в секундах</a></li>
  <li><a href="#websiteMaxWidth">Максимальная ширина сайта в пикселях</a></li>
  <li><a href="#pageLoadTimeout">Таймаут загрузки страницы в миллисекундах</a></li>
  <li><a href="#trackValidationErrors">Отслеживать ошибки валидации</a></li>
  <li><a href="#trackJsErrors">Отслеживать все ошибки JavaScript</a></li>
  <li><a href="#cookieConsent">Согласие на использование Cookies</a></li>
  <li><a href="#unpersistContextCampaignOnTransaction">Очищать context.campaign после "Completed Transaction"</a></li>
</ul>

### <a name="intro"></a>Введение
------
Чтобы задать настройки:
1. Авторизуйтесь на сайте [segmentstream.com](https://admin.segmentstream.com/)
2. Кликните на ссылку "настройки" в правом верхнем углу окна.
3. Сделайте настройки согласно документации ниже
4. Опубликуйте проект.

![](/img/settings.png)

### <a name="sendViewedPageEvent"></a>Автоматическая отправка события Viewed Page
------
Событие `Viewed Page` - это базовое событие. Оно необходимо для работы большинства сторонних систем. Вместе с событием Viewed Page в сторонние системы отправляются различные данные из объекта `digitalData`: `digitalData.page.type`, `digitalData.user.userId`, `digitalData.listing.categoryId` и многие другие.

> Событие `Viewed Page`  должно быть добавлено в массив `digitalData.events` только после полного заполнения данными объекта `digitalData`.

По умолчанию SegmentStream автоматически добавляет событие `Viewed Page` в массив `digitalData.events` в момент загрузки библиотеки `ddmanager.js`. Это происходит при каждой загрузке страницы.

Если вы добавляете событие `Viewed Page` в массив `digitalData.events` самостоятельно из кода сайта, делайте это только после заполнения объекта digitalData всеми переменными. В этом случае выключите тумблер "Автоматической отправки события Viewed Page".

### <a name="useCookieStorage"></a>Использовать Cookie вместо LocalStorage для хранения данных
------
SegmentStream позволяет на основе событий и переменных объекта `digitalData` создавать новые переменные и сохранять их на определенный срок. Например: вам необходимо передать в google analytics количество просмотров карточек товаров перед покупкой. Подробнее о сохранении переменных читайте в разделе [Переменные](/ru/for-analyst/events/).

По умолчанию значение любой переменной сохраняется в [LocalStorage](https://www.w3schools.com/html/html5_webstorage.asp) браузера посетителя в виде строки. LocalStorage поддерживается всеми современными браузерами. В отличие от Cookie, LocalStorage является более безопасным хранилищем, вмещает до 5 мб, и информация никогда не отправляется на сервер.

Однако LocalStorage хранит информацию в рамках одного домена. Это значит, что вы не можете получить доступ к информации со страниц поддомена.

> Если разные разделы вашего сайта расположены на поддоменах - используйте Cookie вместо LocalStorage

В качестве домена для установки cookie укажите домен верхнего уровня.
Например, ваш интернет-магазин расположен по адресу https://shop.ru, но корзина расположена по адресу https://cart.shop.ru. Чтобы со страниц корзины была доступна информация, сохраненная на страницах карточек товаров, необходимо использовать cookie с доменом shop.ru

> Cookie хранят только 4кб. Обратите на это внимание при сохранении больших массивов или строк.

### <a name="sessionLength"></a> Длина сессии в секундах
------
SegmentStream имеет встроенное событие `Session Started`. Это событие автоматически добавляется в массив `digitalData.events` в случае, если у данного пользователя с момента любого другого события прошло больше заданного отрезка времени. По умолчанию этот отрезок времени (Длина сессии) равен одному часу или 3600 секунд.
Примеры:
1. Пользователь впервые попал на сайт. Одновременно с первым событием `Viewed Page` SegmentStream добавит событие `Session Started` в массив `digitalData.events`.
2. Пользователь ходил по сайту, оставил вкладку браузера открытой и ушел на 2 часа. Пользователь вернулся к сайту и кликнул на баннер или перешел на другую страницу. В этот момент событие `Session Started` будет автоматически добавлено в массив `digitalData.events`.

Это событие может вам понадобиться, если вы захотите обнулять или перезаписывать значение переменной в объекте digitalData в момент старта новой сессии.

> Рекомендуем и в Google Analytics и в SegmentStream задать одинаковую длину сессии.

### <a name="websiteMaxWidth"></a> Максимальная ширина сайта в пикселях
------
Если вы используете на сайте блок со слайдером баннеров, рекомендуем задать в поле настройки максимальную ширину окна вашего сайта. Эта настройка поможет правильно учитывать [события показов баннеров](/ru/events/viewed-campaign).

### <a name="pageLoadTimeout"></a> Таймаут загрузки страницы в миллисекундах
------
SegmentStream попытается загрузить интеграции из блока "После загрузки сайта" (подробнее на странице [Приоритеты](/ru/for-analyst/priorities)) даже если не наступило событие `onload` для `window`.

### <a name="trackValidationErrors"></a> Отслеживать ошибки валидации
------
SegmentStream имеет встроенный [модуль отслеживания ошибок работы интеграций](/ru/for-analyst/integrations#2). Данный модуль выводит в консоль разработчика информацию обо всех данных, отправляемых в сторонние системы. Если вы включите отслеживание ошибок валидации, то каждый раз при возникновении ошибки в работе интеграции у любого из посетителей сайта, SegmentStream будет автоматически добавлять это событие в массив `digitalData.events`. Теперь это событие может быть отправлено в любую систему статистики для последующего анализа причин возникновения ошибки.

Если у вас настроена интеграция с [Google Analytics](/ru/integrations/google-analytics), информацию об ошибках валидации вы найдете в отчетах по событиям.

### <a name="trackJsErrors"></a> Отслеживать все ошибки JavaScript
------
SegmentStream также умеет перехватывать сообщения о возникновении любых JavaScript-ошибок на вашем сайте. Обычно на сайтах происходят тысячи ошибок: не подгружаются библиотеки сторонних систем, ошибки в скриптах разработчиков, непредвиденные действия пользователей и так далее. Все эти ошибки могут быть переданы в Google Analytics с хитами типа [exceptions](https://developers.google.com/analytics/devguides/collection/analyticsjs/exceptions). Построив кастомный отчет в интерфейсе Google Analytics вы сможете найти страницы и условия при которых случаются ошибки.

![](/img/settings.1.png)
Пример настройки отчета в интерфейсе Google Analytics

### <a name="cookieConsent"></a> Согласие на использование Cookies
------
SegmentStream поддерживает общий регламент по защите данных (GDPR).
По умолчанию работает политика None, которая не предусматривает защиту данных.
Чтобы установить поддержку регламента по защите данных вам необходимо произвести следующие действия:

1. Убедиться, что на сайте установлена самая последняя версия [сниппета SegmentStream](/ru/for-developer/snippet).
2. Выбрать политику в настройках проекта по адресу [https://admin.segmentstream.com/](https://admin.segmentstream.com/) (см скриншот в разделе введение).
3. Добавить после сниппета обработчик события для изменения согласия пользователя на обработку своих данных:

```
ddManager.on('ready', function() {
  // в переменной consent будет решение
  // пользователя по обработке своих данных:
  // undefined - пользователь не принял решение
  // true - пользователь согласен на обработку данных
  // false - пользователь не согласен на обработку данных
  var consent = ddManager.getConsent();

  if (consent === undefined) {
    // показать всплывающее окно или баннер
    // для получения согласия пользователя
    // Если используется регламент Opt-in / Opt-out
    // нужно добавить обработчики событий принятия или отказа,
    // вызывающие метод ddManager.setConsent()
  }
});
```

В защите данных предусматривается 4 вида регламентов:

- **None**
- **Info**
- **Opt-in**
- **Opt-out**

**None** - значение по умолчанию. При значении **None** SegmentStream отправляет пользовательские данные во все подключенные системы.

**Info** - режим информирования. В данном режиме, при первичном посещении сайта, необходимо показать пользователю баннер или всплывающее окно с информацией о том, что данный сайт собирает пользовательские данные. SegmentStream автоматически вызывает функцию `ddManager.setConsent(true);`, которая передаст в переменную `digitalData.consent` значение `true` после совершения пользователем любого из действий: нажатие клавиши на клавиатуре, клик, скролл, проведение пальцем по сенсорному экрану на области страницы сайта. **Начиная со следующего события `Viewed Page`**, SegmentStream станет отправлять пользовательские данные во все подключенные системы.

**Opt-in** - режим, требующий явного согласие пользователя на передачу данных сторонним системам. В данном режиме, при первичном посещении сайта, необходимо показать пользователю баннер или всплывающее окно с информацией о том, что данный сайт собирает пользовательские данные.
 - Если пользователь согласен, он нажимает на кнопку принятия, после чего код сайта вызывает функцию `ddManager.setConsent(true);`, которая передаст в переменную `digitalData.cookieConsent` значение `true`. **Начиная со следующего события `Viewed Page`**, SegmentStream станет отправлять пользовательские данные во все подключенные системы.
 - Если пользователь не согласен, код сайта вызывает функцию `ddManager.setConsent(false);`, которая передаст в переменную `digitalData.cookieConsent` значение `false`. SegmentStream не будет отправлять пользовательские данные ни в одну из подключенных систем.

**Opt-out** - режим, требующий явного отказа пользователя от передачи данных сторонним системам. При первичном посещении сайта SegmentStream отправляет пользовательские данные во все подключенные системы. При этом, необходимо сразу показать пользователю баннер с информацией о том, что пользовательские данные собираются.
 - Если пользователь согласен, он нажимает на кнопку принятия. После нажатия код сайта вызывает функцию `ddManager.setConsent(true);`, которая передаст в переменную `digitalData.cookieConsent` значение `true`. SegmentStream продолжит отправлять пользовательские данные во все подключенные системы.
 - Если пользователь не согласен, он нажимает на кнопку отказа. После нажатия код сайта вызывает функцию `ddManager.setConsent(false);`, которая передаст в переменную `digitalData.cookieConsent` значение `false`. С этого момента SegmentStream не будет отправлять пользовательские данные ни в одну из подключенных систем.

---

> В режимах **Info** и **Opt-in**, SegmentStream не загружает библиотеки интеграций. После получения акцепта пользователя SegmentStream ожидает следующего события **Viewed Page**, поэтому SPA-приложения должны сами сгенерировать событие **Viewed Page** после согласия пользователя.

На сайте [https://demo.segmentstream.com](https://demo.segmentstream.com) реализован пример защиты данных по регламенту **Opt-in**.

### <a name="unpersistContextCampaignOnTransaction"></a> Очищать context.campaign после "Completed Transaction"
------
При каждом переходе на сайт, SegmentStream автоматически считывает utm_метки из url перехода, заполняет данными объект `context.campaign`. Подробнее читайте в разделе [context](/ru/digitaldata/context#7).
По-умолчанию, содержание объекта `context.campaign` хранится до загрузки любого url сайта с новыми utm_метками или до наступления события `Completed Transaction`.
Вы можете включить или отключить очистку объекта `context.campaign` с помощью данного переключателя.
